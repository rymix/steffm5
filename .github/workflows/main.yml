name: Main Build, Test and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Modules
        run: yarn install

      - name: Format Code
        run: npx prettier --write "**/*.{ts,tsx,js,jsx}"

      - name: Run Build
        run: yarn run build

      - name: Run Tests
        run: yarn test

      - name: Debug standalone structure
        run: |
          echo "=== Checking standalone directory structure ==="
          find .next/standalone -type d -maxdepth 3 | head -20
          echo "=== Contents of standalone root ==="
          ls -la .next/standalone/ || echo "standalone root not found"
          echo "=== Looking for server.js ==="
          find .next/standalone -name "server.js" -type f

      - name: Create wwwroot structure
        run: |
          mkdir -p wwwroot

          # Find the actual standalone directory (could be Node/steffm5 or steffm5/steffm5)
          if [ -d ".next/standalone/Node/steffm5" ]; then
            STANDALONE_DIR=".next/standalone/Node/steffm5"
          elif [ -d ".next/standalone/steffm5/steffm5" ]; then
            STANDALONE_DIR=".next/standalone/steffm5/steffm5"
          else
            echo "Error: Could not find standalone directory"
            exit 1
          fi

          echo "Using standalone directory: $STANDALONE_DIR"

          # Copy files, only if they exist
          [ -d "$STANDALONE_DIR/.next" ] && cp -R "$STANDALONE_DIR/.next" wwwroot/ || echo "Skipping .next (not found)"
          [ -d "$STANDALONE_DIR/db" ] && cp -R "$STANDALONE_DIR/db" wwwroot/ || echo "Skipping db (not found)"
          [ -d "$STANDALONE_DIR/node_modules" ] && cp -R "$STANDALONE_DIR/node_modules" wwwroot/ || echo "Skipping node_modules (not found)"
          [ -f "$STANDALONE_DIR/package.json" ] && cp "$STANDALONE_DIR/package.json" wwwroot/ || echo "Skipping package.json (not found)"
          [ -d "$STANDALONE_DIR/pages" ] && cp -R "$STANDALONE_DIR/pages" wwwroot/ || echo "Skipping pages (not found)"
          [ -d "$STANDALONE_DIR/public" ] && cp -R "$STANDALONE_DIR/public" wwwroot/ || echo "Skipping public (not found)"
          [ -f "$STANDALONE_DIR/server.js" ] && cp "$STANDALONE_DIR/server.js" wwwroot/ || echo "Skipping server.js (not found)"

          echo "=== wwwroot contents ==="
          ls -la wwwroot/

      - name: Zip wwwroot
        run: zip -r wwwroot.zip wwwroot

      - name: Upload Zipped wwwroot
        uses: actions/upload-artifact@v4
        with:
          name: wwwroot
          path: wwwroot.zip

  deploy:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Download Zipped wwwroot
        uses: actions/download-artifact@v4
        with:
          name: wwwroot
          path: .

      - name: Unzip wwwroot
        run: unzip wwwroot.zip

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Key Vault Secrets
        id: keyvault
        run: |
          echo "NEXT_PUBLIC_DISCOGS_API_TOKEN=$(az keyvault secret show --name NEXTPUBLICDISCOGSAPITOKEN --vault-name stef-fm-secrets --query value -o tsv)" >> $GITHUB_ENV
          echo "JWT_SECRET=$(az keyvault secret show --name JWTSECRET --vault-name stef-fm-secrets --query value -o tsv)" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_API_URL=$(az keyvault secret show --name NEXTPUBLICAPIURL --vault-name stef-fm-secrets --query value -o tsv)" >> $GITHUB_ENV

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: "steffm"
          publish-profile: ${{ secrets.STEFFM_PUBLISH_PROFILE }}
          package: wwwroot

      - name: Set environment variables for Node.js
        run: |
          az webapp config appsettings set --name "steffm" --resource-group "Stef.FM" --settings NEXT_PUBLIC_DISCOGS_API_TOKEN=${{ env.NEXT_PUBLIC_DISCOGS_API_TOKEN }} JWT_SECRET=${{ env.JWT_SECRET }} NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}

      - name: Clean up wwwroot.zip
        uses: geekyeggo/delete-artifact@v5
        with:
          name: wwwroot
          failOnError: false
